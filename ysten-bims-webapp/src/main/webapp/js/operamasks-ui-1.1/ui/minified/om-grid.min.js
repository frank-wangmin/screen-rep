(function(a){a.omWidget("om.omGrid",{options:{height:462,width:"100%",colModel:false,autoFit:false,showIndex:true,dataSource:false,extraData:{},method:"GET",preProcess:false,limit:15,rowClasses:["oddRow","evenRow"],singleSelect:true,title:"",onRowSelect:function(d,c,b){},onRowDeselect:function(d,c,b){},onRowClick:function(d,c,b){},onRowDblClick:function(d,c,b){},onPageChange:function(c,b,d){},onSuccess:function(e,b,d,c){},onError:function(c,e,d,b){},onRefresh:function(d,b,c){}},_create:function(){var c=this.options,e=this.element.show().attr({cellPadding:0,cellSpacing:0,border:0}).empty().append("<tbody></tbody>");e.wrap('<div class="om-grid om-widget om-widget-content"><div class="bDiv"></div></div>').closest(".om-grid");var b=c.colModel;if(!a.isArray(b)){return}this.hDiv=a('<div class="hDiv om-state-default"></div>').append('<div class="hDivBox"><table cellPadding="0" cellSpacing="0"></table></div>');e.parent().before(this.hDiv);this.pDiv=a('<div class="pDiv om-state-default"></div>');e.parent().after(this.pDiv);var d=e.closest(".om-grid");this.loadMask=a('<div class="gBlock"><div align="center" class="gBlock-valignMiddle" ><div class="loadingImg" style="display:block"/></div></div>').mousedown(function(f){return false}).hide();d.append(this.loadMask);this.titleDiv=a("<div class='titleDiv'></div>");d.prepend(this.titleDiv);this.tbody=this.element.children().eq(0)},_init:function(){var f=this.element,d=this.options,e=f.closest(".om-grid");e.width(d.width).height(d.height);if(!a.isArray(this.options.colModel)){return}this.tbody.empty();a("table",this.hDiv).empty();this.pDiv.empty();this.titleDiv.empty();this._buildTableHead();this._buildPagingToolBar();this._buildLoadMask();this._bindSelectAndClickEnvent();this._bindScrollEnvent();this._makeColsResizable();this._buildTitle();var g=e.children(".hDiv").outerHeight(),b=e.children(".pDiv").outerHeight()||0,h=e.children(".titleDiv").outerHeight()||0,c=e.children(".bDiv");c.height(e.height()-g-b-h);this.pageData={nowPage:1,totalPages:1};this._populate()},_buildTitle:function(){this.titleDiv.empty();if(this.options.title){this.titleDiv.html("<div class='titleContent'>"+this.options.title+"</div>");this.titleDiv.css("height","")}else{this.titleDiv.css("height",0)}},_buildTableHead:function(){var n=this.options,e=this.element,b=e.closest(".om-grid"),o=n.colModel,v=0,p=0,h=0,k=-1;thead=a("<thead></thead>");tr=a("<tr></tr>").appendTo(thead);if(n.showIndex){var d=a("<th></th>").attr({axis:"indexCol",align:"center"}).addClass("indexCol").append(a('<div class="indexheader" style="text-align:center;width:25px;"></div>'));tr.append(d);p=25}if(!n.singleSelect){var d=a("<th></th>").attr({axis:"checkboxCol",align:"center"}).addClass("checkboxCol").append(a('<div class="checkboxheader" style="text-align:center;width:17px;"><span class="checkbox"/></div>'));tr.append(d);h=17}for(var s=0,t=o.length;s<t;s++){var l=o[s],m=l.width||60,q=l.align||"center";if(m=="autoExpand"){m=0;k=s}var r=a("<div></div>").html(l.header).css({"text-align":q,width:m});l.wrap&&r.addClass("wrap");var g=a("<th></th>").attr("axis","col"+s).addClass("col"+s).append(r);if(l.name){g.attr("abbr",l.name)}if(l.align){g.attr("align",l.align)}v+=m;tr.append(g)}e.prepend(thead);a("table",this.hDiv).append(thead);if(k!=-1){var u=b.width()-30,x=tr.find('th[axis="col'+k+'"] div');x.parent().hide();var j=u-thead.width();x.parent().show();if(j<=0){x.css("width",60)}else{x.css("width",j)}}else{if(n.autoFit){var u=b.width()-20,j=u-thead.width(),c=1+j/v,w=tr.find('th[axis^="col"] div');for(var s=0,t=o.length;s<t;s++){var f=w.eq(s);f.css("width",parseInt(f.width()*c))}}}this.thead=thead;thead=null},_buildPagingToolBar:function(){var f=this.options;if(f.limit<=0){return}var c=this,d=this.element,b=this.pDiv;b.html('<div class="pDiv2"><div class="pGroup"><div class="pFirst pButton om-icon"><span class="om-icon-seek-start"></span></div><div class="pPrev pButton om-icon"><span class="om-icon-seek-prev"></span></div></div><div class="btnseparator"></div><div class="pGroup"><span class="pControl"></span></div><div class="btnseparator"></div><div class="pGroup"><div class="pNext pButton om-icon"><span class="om-icon-seek-next"></span></div><div class="pLast pButton om-icon"><span class="om-icon-seek-end"></span></div></div><div class="btnseparator"></div><div class="pGroup"><div class="pReload pButton om-icon"><span class="om-icon-refresh"></span></div></div><div class="btnseparator"></div><div class="pGroup"><span class="pPageStat"></span></div></div>');var e=a.om.lang._get(f,"omGrid","pageText").replace(/{totalPage}/,"<span>1</span>").replace(/{index}/,'<input type="text" size="4" value="1" />');a(".pControl",b).html(e);d.parent().after(b);a(".pReload",b).click(function(){c._populate()});a(".pFirst",b).click(function(){c._changePage("first")});a(".pPrev",b).click(function(){c._changePage("prev")});a(".pNext",b).click(function(){c._changePage("next")});a(".pLast",b).click(function(){c._changePage("last")});a(".pControl input",b).keydown(function(g){if(g.keyCode==a.om.keyCode.ENTER){c._changePage("input")}});a(".pButton",b).hover(function(){a(this).addClass("om-state-hover")},function(){a(this).removeClass("om-state-hover")});this.pager=b},_buildLoadMask:function(){var b=this.element.closest(".om-grid");this.loadMask.css({width:b.width(),height:b.height()})},_changePage:function(c){if(this.loading){return true}var e=this.element,h=this.options,b=e.closest(".om-grid"),d=this.pageData,g=d.nowPage,i=d.totalPages,f=g;this._oldPage=g;switch(c){case"first":f=1;break;case"prev":if(g>1){f=g-1}break;case"next":if(g<i){f=g+1}break;case"last":f=i;break;case"input":var j=parseInt(a(".pControl input",e.closest(".om-grid")).val());if(isNaN(j)){j=g}if(j<1){j=1}else{if(j>i){j=i}}a(".pControl input",this.pDiv).val(j);f=j;break;default:if(/\d/.test(c)){var j=parseInt(c);if(isNaN(j)){j=1}if(j<1){j=1}else{if(j>i){j=i}}a(".pControl input",e.closest(".om-grid")).val(j);f=j}}if(f==g){return false}if(this._trigger("onPageChange",null,c,f)===false){return}d.nowPage=f;a("th.checkboxCol span.checkbox",b).removeClass("selected");this._populate()},_populate:function(){var k=this,f=this.element,b=f.closest(".om-grid"),j=this.options,e=a(".pPageStat",b);if(!j.dataSource){a(".pPageStat",b).html(j.emptygMsg);return false}if(this.loading){return true}var d=this.pageData,h=d.nowPage||1,c=a(".gBlock",b);this.loading=true;e.html(a.om.lang._get(j,"omGrid","loadingMsg"));c.show();if(a.browser.opera){a(b).css("visibility","hidden")}var i=(j.limit<=0)?100000000:j.limit;var g=a.extend(true,j.extraData,{start:i*(h-1),limit:i,_time_stamp_:new Date().getTime()});a.ajax({type:j.method,url:j.dataSource,data:g,dataType:"json",success:function(m,o,l){var n=j.onSuccess;if(typeof(n)=="function"){k._trigger("onSuccess",null,m,o,l)}k._addData(m);k._trigger("onRefresh",null,h,m.rows);c.hide();k.loading=false},error:function(m,p,o){e.html(a.om.lang._get(j,"omGrid","errorMsg")).css("color","red");try{var l=j.onError;if(typeof(l)=="function"){l(m,p,o)}}catch(n){}finally{c.hide();k.loading=false;return false}}})},_addData:function(g){var h=this.options,f=this.element,e=f.closest(".om-grid"),b=a(".pPageStat",e),d=h.preProcess,c=this.pageData;d&&(g=d(g));c.data=g;c.totalPages=Math.ceil(g.total/h.limit);this._buildPager();this._renderDatas()},_buildPager:function(){var i=this.options;if(i.limit<=0){return}var e=this.element,g=this.pager,b=a(".pControl",g),d=this.pageData,f=d.nowPage,j=d.totalPages,h=d.data,l=i.limit*(f-1)+1,k=l-1+h.rows.length,c="";if(h.total===0){c=a.om.lang._get(i,"omGrid","emptyMsg")}else{c=a.om.lang._get(i,"omGrid","pageStat").replace(/{from}/,l).replace(/{to}/,k).replace(/{total}/,h.total)}a("input",b).val(f);a("span",b).html(j);a(".pPageStat",g).html(c)},_renderDatas:function(l,m){var n=this,f=this.element,i=this.options,c=f.closest(".om-grid"),j=a(".hDiv thead tr:first th",c),o=this.pageData.data.rows,k=i.colModel,g=i.rowClasses,h=a("tbody",f).empty(),b=(typeof g==="function"),e=this.pageData,d=(e.nowPage-1)*i.limit;a.each(o,function(p,s){var r=b?g(p,s):g[p%g.length];var q=a('<tr class="om-grid-row"></tr>').addClass(r);var t=n._buildRowCellValues(k,s,p);a(j).each(function(){var x=a(this).attr("axis"),w=false,v;if(x=="indexCol"){v=p+d+1}else{if(x=="checkboxCol"){v='<span class="checkbox"/>'}else{if(x.substring(0,3)=="col"){var u=x.substring(3);v=t[u];if(k[u].wrap){w=true}}else{v=""}}}var y=a("<td></td>").attr({align:this.align,abbr:this.abbr}).addClass(x).append(a("<div></div>").html(v).addClass(w?"wrap":"").attr({align:this.align}).width(a("div",a(this)).width()));q.append(y)});h.append(q)})},_buildRowCellValues:function(j,d,h){var f=j.length,k=[];for(var e=0;e<f;e++){var g=j[e],l=d[g.name],b=g.renderer;if(typeof b==="function"){l=b(l,h)}k[e]=l}return k},_bindScrollEnvent:function(){var b=this.thead.closest(".hDiv");this.tbody.closest(".bDiv").scroll(function(){b.scrollLeft(a(this).scrollLeft())})},_bindSelectAndClickEnvent:function(){var b=this;if(!this.options.singleSelect){a("th.checkboxCol span.checkbox",this.thead).click(function(){var e=a(this),d=a("tr",b.tbody).size();if(e.hasClass("selected")){e.removeClass("selected");for(var c=0;c<d;c++){b._rowDeSelect(c)}}else{e.addClass("selected");for(var c=0;c<d;c++){b._rowSelect(c)}}});this.tbody.delegate("tr.om-grid-row","click",function(d){var e=a(this),c=e.index();if(e.hasClass("om-state-highlight")){b._rowDeSelect(c)}else{b._rowSelect(c)}b._refreshHeaderCheckBox();b._trigger("onRowClick",d,c,b._getRowData(c))});this.tbody.delegate("tr.om-grid-row","dblclick",function(d){var e=a(this),c=e.index();if(e.hasClass("om-state-highlight")){}else{b._rowSelect(c);b._refreshHeaderCheckBox()}b._trigger("onRowDbClick",d,c,b._getRowData(c))})}else{this.tbody.delegate("tr.om-grid-row","click",function(d){var f=a(this),c=f.index();if(f.hasClass("om-state-highlight")){}else{var e=a("tr.om-state-highlight",b.tbody).index();(e!=-1)&&b._rowDeSelect(e);b._rowSelect(c)}b._trigger("onRowClick",d,c,b._getRowData(c))});this.tbody.delegate("tr.om-grid-row","dblclick",function(d){var c=a(this).index();b._trigger("onRowDblClick",d,c,b._getRowData(c))})}},_getRowData:function(b){return this.pageData.data.rows[b]},_rowSelect:function(d){var e=this.element,g=this.options,c=a("tbody",e),f=a("tr:eq("+d+")",c),b=a("td.checkboxCol span.checkbox",f);f.addClass("om-state-highlight");b.addClass("selected");this._trigger("onRowSelect",null,d,this._getRowData(d))},_rowDeSelect:function(e){var c=this,f=this.element,h=this.options,d=a("tbody",f),g=a("tr:eq("+e+")",d),b=a("td.checkboxCol span.checkbox",g);g.removeClass("om-state-highlight");b.removeClass("selected");this._trigger("onRowDeselect",null,e,this._getRowData(e))},_refreshHeaderCheckBox:function(){var b=a("td.checkboxCol span.selected",this.tbody).size(),c=a("th.checkboxCol span.checkbox",this.thead);if(b<this.pageData.data.rows.length){c.removeClass("selected")}else{c.addClass("selected")}},_makeColsResizable:function(){var c=this,f=c.tbody.closest(".bDiv"),e=c.element.closest(".om-grid"),d=this.titleDiv,b=c.pager;a('th[axis^="col"] div',c.thead).resizable({handles:"e",containment:"document",minWidth:60,resize:function(k,j){var l=a(this),h=l.parent().attr("abbr"),i=a('td[abbr="'+h+'"] > div',c.tbody),g=c.thead.closest(".hDiv");l.width(k.size.width).height("");i.width(k.size.width).height("");f.height(e.height()-d.outerHeight()-g.outerHeight()-b.outerHeight())}})},setData:function(b){this.options.dataSource=b;this.pageData={nowPage:1,totalPages:1};this._populate()},getData:function(){return this.pageData.data},refresh:function(){if(this.loading){return true}this.loading=true;var b=this.options;a(".pPageStat",this.pager).html(a.om.lang._get(b,"omGrid","loadingMsg"));this.loadMask.show();this._buildPager();this._renderDatas();this._trigger("onRefresh",null,this.pageData.nowPage||1,this.pageData.data.rows);this.loadMask.hide();this.loading=false},reload:function(b){if(this.loading){return true}if(typeof b!=="undefined"){b=parseInt(b)||1;if(b<0){b=1}if(b>this.pageData.totalPages){b=this.pageData.totalPages}this.pageData.nowPage=b}this._populate()},setSelections:function(c){var b=this;if(!a.isArray(c)){c=[c]}var d=this.getSelections();a(d).each(function(){b._rowDeSelect(this)});a(c).each(function(){b._rowSelect(this)});b._refreshHeaderCheckBox()},getSelections:function(d){var e=this,c=a("tr.om-state-highlight",this.tbody),b=[];if(d){var f=e.pageData.data.rows;c.each(function(){b[b.length]=f[a(this).index()]})}else{c.each(function(){b[b.length]=a(this).index()})}return b},destroy:function(){var b=this.element;b.closest(".om-grid").after(b).remove()}})})(jQuery);